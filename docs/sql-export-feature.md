# SQL Export Feature Documentation

## Tổng quan
Tính năng **Export SQL** cho phép xuất toàn bộ database thành file SQL có thể chạy trực tiếp trong Supabase SQL Editor.

## ⚠️ Migration Requirement
**Bắt buộc chạy migration 005** để sử dụng tính năng này:
```
supabase/migrations/005_auth_access_functions.sql
```

## Cách sử dụng

### 1. Truy cập Backup Manager
- Vào trang Super Admin Dashboard
- Chọn "Backup" từ menu
- Tìm section "Export SQL" trong danh sách backup options

### 2. Export SQL
- Click vào card "Export SQL"
- Hệ thống sẽ tự động:
  - Thu thập schema của tất cả user tables (via `pos_mini_modular3_get_all_tables_info()`)
  - Export dữ liệu từng table (via `pos_mini_modular3_get_auth_users()` cho auth.users)
  - Tạo file SQL với định dạng Supabase-compatible
  - Download file tự động

### 3. Sử dụng file SQL
- Mở Supabase Dashboard
- Vào SQL Editor
- Upload hoặc copy-paste nội dung file SQL
- Chạy script

## Đặc điểm kỹ thuật

### Database Functions Required (Migration 005):
- `pos_mini_modular3_get_all_tables_info()` - List all exportable tables
- `pos_mini_modular3_get_auth_users()` - Safe access to auth.users table

### File SQL được tạo bao gồm:
- **Transaction wrapper** (`BEGIN` ... `COMMIT`)
- **CREATE TABLE statements** với đầy đủ constraints
- **INSERT statements** với ON CONFLICT handling
- **Proper data type mapping** cho PostgreSQL
- **Error recovery instructions** trong comments

### Format dữ liệu:
```sql
BEGIN;

-- ========================================
-- Database Export Generated by POS Mini Modular 3
-- Export Date: 2024-01-15T10:30:00Z
-- Tables: businesses, users, products, etc.
-- ========================================

-- Create table structure
CREATE TABLE IF NOT EXISTS "businesses" (
    "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "name" TEXT NOT NULL,
    "created_at" TIMESTAMPTZ DEFAULT NOW()
);

-- Insert data with conflict resolution
INSERT INTO "businesses" ("id", "name", "created_at")
VALUES 
    ('uuid-1', 'Business 1', '2024-01-01T00:00:00Z'),
    ('uuid-2', 'Business 2', '2024-01-02T00:00:00Z')
ON CONFLICT ("id") DO UPDATE SET
    "name" = EXCLUDED."name",
    "created_at" = EXCLUDED."created_at";

COMMIT;
```

## Ưu điểm

### 1. **Supabase Native**
- Format SQL được tối ưu cho PostgreSQL/Supabase
- Tương thích 100% với Supabase SQL Editor
- Sử dụng đúng data types và constraints

### 2. **Safe Execution**
- UPSERT pattern (INSERT ... ON CONFLICT) tránh duplicate errors
- Transaction wrapper đảm bảo tính toàn vẹn
- Error handling và recovery instructions

### 3. **Production Ready**
- Có thể chạy an toàn trên production database
- Không gây mất dữ liệu hiện tại
- Merge thông minh dữ liệu mới và cũ

### 4. **Human Readable**
- SQL được format đẹp, dễ đọc
- Comments chi tiết giải thích từng phần
- Có thể edit manual trước khi chạy

## So sánh với JSON Backup

| Feature | JSON Backup | SQL Export |
|---------|-------------|------------|
| **Restore Method** | API endpoint | SQL Editor |
| **Human Readable** | ❌ Khó đọc | ✅ Dễ đọc |
| **Editable** | ❌ Không | ✅ Có thể edit |
| **Direct Run** | ❌ Cần API | ✅ Direct SQL |
| **Supabase Native** | ❌ Custom format | ✅ Native SQL |
| **File Size** | Nhỏ hơn | Lớn hơn |
| **Speed** | Nhanh hơn | Chậm hơn |

## Khi nào sử dụng

### Sử dụng SQL Export khi:
- ✅ Cần migrate dữ liệu sang database khác
- ✅ Muốn inspect/edit dữ liệu trước khi restore
- ✅ Cần backup format standard, portable
- ✅ Làm việc với team dev khác cần hiểu cấu trúc data
- ✅ Cần chạy manual trên Supabase SQL Editor

### Sử dụng JSON Backup khi:
- ✅ Cần backup/restore nhanh, tự động
- ✅ Không cần edit dữ liệu
- ✅ Cần tiết kiệm storage space
- ✅ Restore thường xuyên qua API

## Technical Implementation

### API Endpoint
```
POST /api/admin/backup/export-sql
```

### Response
- Content-Type: `application/sql`
- File download với tên: `database_export_YYYYMMDD_HHMMSS.sql`

### Backend Implementation
- **SQLExporter class** xử lý logic export
- **Schema extraction** từ `information_schema`
- **Data extraction** với pagination cho tables lớn
- **Type mapping** PostgreSQL native
- **Error handling** comprehensive

## Troubleshooting

### Lỗi thường gặp:

1. **"Permission denied"**
   - Đảm bảo user có quyền admin
   - Check authentication token

2. **"Table not found"**
   - Database có thể bị thay đổi trong lúc export
   - Thử export lại

3. **"Large file timeout"**
   - Database quá lớn
   - Cân nhắc export từng table riêng lẻ

### Performance Tips:
- Export trong giờ ít traffic
- Tables lớn có thể mất vài phút
- Monitor progress qua UI

## Files liên quan

- `/app/api/admin/backup/export-sql/route.ts` - API endpoint
- `/components/backup/backup-manager.tsx` - UI component
- `/tests/sql-export-test.js` - Test specifications

## Version History

- **v1.0** - Initial SQL export feature
- **v1.1** - Added progress tracking
- **v1.2** - Enhanced UI and documentation
